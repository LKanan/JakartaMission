<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="jakarta.faces.html"
      xmlns:f="jakarta.faces.core"
      xmlns:ui="jakarta.faces.facelets">
    <h:head>
        <title>Guide de visite</title>
        <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
        <script type="text/javascript" src="guide.js"></script>
    </h:head>
    <h:body class="bg-gray-100 min-h-screen">
        <section class="max-w-6xl mx-auto py-10 px-4 sm:px-6 lg:px-8">
            
            <!-- Zone de messages (Toast/Notification) -->
            <h:messages globalOnly="true" 
                        styleClass="mb-6 p-4 rounded-xl shadow-md block text-center font-medium"
                        infoClass="bg-green-100 text-green-800 border border-green-200"
                        errorClass="bg-red-100 text-red-800 border border-red-200"
                        warnClass="bg-orange-100 text-orange-800 border border-orange-200" />

            <div class="flex flex-col lg:flex-row gap-8">
                <!-- Colonne gauche : sélection du lieu + météo -->
                <div class="flex-1 bg-white rounded-2xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-indigo-700 mb-4">Préparer ma visite</h2>
                    <h:form id="formSelection">
                        <div class="mb-4">
                            <label for="lieuSelect" class="block text-sm font-medium text-gray-700 mb-1">Lieu à visiter</label>
                            <h:selectOneMenu id="lieuSelect" value="#{visiteBean.lieuSelectionneId}"
                                             styleClass="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 bg-white py-2 px-3">
                                <f:selectItem itemLabel="-- Sélectionnez un lieu --" itemValue="0" />
                                <f:selectItems value="#{lieuBean.lieux}" var="l"
                                               itemValue="#{l.id}" itemLabel="#{l.nom}" />
                                <f:ajax listener="#{visiteBean.chargerMeteoPourLieuAjax}" render="meteoPanel visiterPanel" />
                            </h:selectOneMenu>
                        </div>

                        <!-- Bloc météo -->
                        <h:panelGroup id="meteoPanel">
                            <h:panelGroup rendered="#{visiteBean.lieuSelectionneId ne 0}">
                                <div class="mt-6 p-4 rounded-xl bg-indigo-50 border border-indigo-100">
                                    <h3 class="text-lg font-semibold text-indigo-700 mb-2">Météo du lieu sélectionné</h3>
                                    <h:outputText id="meteoTexte"
                                                 value="#{visiteBean.meteoTexte}"
                                                 styleClass="text-gray-700 text-sm mb-3 block" />
                                </div>
                            </h:panelGroup>
                        </h:panelGroup>

                        <!-- Bouton pour ouvrir le formulaire de visite -->
                        <h:panelGroup id="visiterPanel">
                            <div class="mt-6">
                                <h:commandButton value="Visiter"
                                                 action="#{visiteBean.afficherFormulaireVisite(visiteBean.lieuSelectionneId)}"
                                                 onclick="ouvrirModalVisite(); return false;"
                                                 styleClass="px-4 py-2 rounded-md bg-emerald-500 text-white font-semibold shadow hover:bg-emerald-600"
                                                 disabled="#{visiteBean.lieuSelectionneId eq 0}" />
                            </div>
                        </h:panelGroup>
                    </h:form>
                </div>

                <!-- Colonne droite : lieux déjà visités -->
                <div class="w-full lg:w-1/3 bg-white rounded-2xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-indigo-700 mb-4">Lieux déjà visités</h2>
                    <div class="space-y-3 max-h-96 overflow-y-auto">
                        <h:panelGroup rendered="#{empty visiteBean.visitesUtilisateur}">
                            <p class="text-gray-500 text-sm">Vous n'avez pas encore enregistré de visite.</p>
                        </h:panelGroup>
                        <h:panelGroup rendered="#{not empty visiteBean.visitesUtilisateur}">
                            <ui:repeat value="#{visiteBean.visitesUtilisateur}" var="v">
                                <div class="border border-gray-200 rounded-xl p-3 flex flex-col gap-1">
                                    <span class="text-sm font-semibold text-gray-800">#{v.lieu.nom}</span>
                                </div>
                            </ui:repeat>
                        </h:panelGroup>
                    </div>
                </div>
            </div>
        </section>

        <!-- Modal visite -->
        <div id="modalVisite" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6 relative">
                <h3 class="text-xl font-semibold text-indigo-700 mb-4">Enregistrer une visite</h3>
                <h:form id="formVisite">
                    <div class="space-y-4">
                        <!-- Utilisateur -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Utilisateur</label>
                            <h:inputText readonly="true"
                                         value="#{utilisateurBean.username}"
                                         styleClass="mt-1 block w-full rounded-md border-gray-300 bg-gray-100 text-gray-600 shadow-sm" />
                        </div>

                        <!-- Date de visite (décorative, non traitée côté serveur) -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Date de visite</label>
                            <h:inputText value="#{visiteBean.dateVisite}"
                                         styleClass="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                                         placeholder="jj-mm-aaaa" />
                        </div>

                        <!-- Temps passé (décoratif) -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Temps passé</label>
                            <h:inputText value="#{visiteBean.tempsPasse}"
                                         styleClass="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                                         placeholder="Ex: 2h30" />
                        </div>

                        <!-- Observations (décoratif) -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Observations</label>
                            <h:inputTextarea value="#{visiteBean.observations}" rows="3"
                                             styleClass="mt-1 block w-full rounded-md border-gray-300 shadow-sm" />
                        </div>

                        <!-- Dépenses (décoratif) -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Dépenses</label>
                            <h:inputTextarea value="#{visiteBean.depenses}" rows="3"
                                             styleClass="mt-1 block w-full rounded-md border-gray-300 shadow-sm" />
                        </div>
                    </div>

                    <div class="mt-6 flex justify-end gap-3">
                        <button type="button" onclick="fermerModalVisite()"
                                class="px-4 py-2 rounded-md border border-gray-300 text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                            Annuler
                        </button>
                        <h:commandButton value="Enregistrer" action="#{visiteBean.enregistrerVisite}"
                                         onclick="fermerModalVisite()"
                                         styleClass="px-4 py-2 rounded-md bg-indigo-600 text-white text-sm font-semibold shadow hover:bg-indigo-700" />
                    </div>
                </h:form>
            </div>
        </div>
    </h:body>
</html>